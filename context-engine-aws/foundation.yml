AWSTemplateFormatVersion: '2010-09-09'
Description: Deploys a Lambda function triggered by an S3 file drop via EventBridge.

Resources:
  IngestionBucket:
    Type: AWS::S3::Bucket
    Properties:
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: lambda.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  S3ProcessorLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: S3-Event-Processor
      Handler: trigger-lambda.main.handler
      Runtime: python3.11
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: dev-context-engine 
        S3Key: autogenerated-key

  S3ObjectCreatedRule:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source: ["aws.s3"]
        detail-type: ["Object Created"]
        detail:
          bucket:
            name: [!Ref IngestionBucket]
      Targets:
        - Arn: !GetAtt S3ProcessorLambda.Arn
          Id: "S3ProcessorLambdaTarget"

  # The permission allowing EventBridge to run the Lambda
  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt S3ProcessorLambda.Arn
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt S3ObjectCreatedRule.Arn